import t,{enableES5 as e}from"immer";import{createContext as n,useState as r,useRef as o,useEffect as i,createElement as c,PureComponent as a}from"react";function s(){return(s=Object.assign||function(t){for(var e=1;e<arguments.length;e++){var n=arguments[e];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(t[r]=n[r])}return t}).apply(this,arguments)}function u(t,e){t.prototype=Object.create(e.prototype),t.prototype.constructor=t,t.__proto__=e}var l={Actions:{},AsyncState:{},Context:{__global:{}},Middlewares:{},Setter:{classSetter:void 0,functionSetter:{}},State:{},devTools:void 0,subscriptions:{},uid:0,withDevTools:!1},f={logger:{enable:!1},devtools:{enable:!1},tryCatch:{enable:!0}},m=function(t,e){try{var n=t.next,r=f.tryCatch.enable?Promise.resolve(n(e).catch(function(t){return console.log(t)})).then(function(){}):Promise.resolve(n(e)).then(function(){});return Promise.resolve(r&&r.then?r.then(function(){}):void 0)}catch(t){return Promise.reject(t)}},S=function(t,e){try{var n=t.modelName,r=t.next,o=t.Global;return Promise.resolve((0,t.action)(t.params,s({actions:(0,t.consumerActions)(o.Actions[n],{modelName:n}),state:o.State[n]},o.Context.__global||{},o.Context[n]||{}))).then(function(n){return t.newState=n||null,Promise.resolve(r(e)).then(function(){})})}catch(t){return Promise.reject(t)}},d=function(t,e){try{var n=t.modelName,r=t.newState,o=t.next,i=t.Global;i.Setter.functionSetter[n]&&Object.keys(i.Setter.functionSetter[n]).map(function(t){var e=i.Setter.functionSetter[n][t];e&&e.selector&&!e.selectorRef&&(e.selectorRef=e.selector(i.State[n]))});var c=function(){if(r)return A(n,r),Promise.resolve(o(e)).then(function(){})}();return Promise.resolve(c&&c.then?c.then(function(){}):void 0)}catch(t){return Promise.reject(t)}},v=function(t,e){try{var n=t.modelName,r=t.next,o=t.Global,i=t.__hash,c=o.Setter.functionSetter[n];return"function"===t.type&&i&&c&&c[i]&&c[i].setState&&c[i].setState(o.State[n]),Promise.resolve(r(e)).then(function(){})}catch(t){return Promise.reject(t)}},h=function(t,e){try{var n=t.next,r=t.Global.subscriptions[t.modelName+"_"+t.actionName];return r&&r.forEach(function(t){t()}),Promise.resolve(n(e)).then(function(){})}catch(t){return Promise.reject(t)}},_=function(t,e){try{var n=t.Global,r=!0===f.logger.enable||"function"==typeof f.logger.enable&&f.logger.enable(t)?(console.group("%c "+t.modelName+" State Change %c "+(new Date).toLocaleTimeString(),"color: gray; font-weight: lighter;","color: black; font-weight: bold;"),console.log("%c Previous","color: #9E9E9E; font-weight: bold",n.State[t.modelName]),console.log("%c Action","color: #03A9F4; font-weight: bold",t.actionName,"payload: "+t.params),Promise.resolve(t.next(e)).then(function(){console.log("%c Next","color: #4CAF50; font-weight: bold",n.State[t.modelName]),console.groupEnd()})):Promise.resolve(t.next(e)).then(function(){});return Promise.resolve(r&&r.then?r.then(function(){}):void 0)}catch(t){return Promise.reject(t)}},p=function(t,e){try{var n=t.Global;return Promise.resolve(t.next(e)).then(function(){n.withDevTools&&f.devtools.enable&&n.devTools.send(t.modelName+"_"+t.actionName,n.State)})}catch(t){return Promise.reject(t)}},b=function(t,e){try{var n=t.modelName,r=t.next,o=t.Global;return o.Setter.classSetter&&o.Setter.classSetter(o.State),o.Setter.functionSetter[n]&&Object.keys(o.Setter.functionSetter[n]).map(function(t){var e=o.Setter.functionSetter[n][t];if(e)if(e.selector){var r=e.selector(o.State[n]);T(r,e.selectorRef)||(e.selectorRef=r,e.setState(o.State[n]))}else e.setState(o.State[n])}),Promise.resolve(r(e)).then(function(){})}catch(t){return Promise.reject(t)}},y=[m,_,p,S,d,v,b,h],g={communicator:b,consoleDebugger:_,devToolsListener:p,getNewState:S,getNewStateWithCache:function(t){return void 0===t&&(t=5e3),function(e,n){try{var r=e.Global,o=e.modelName,i=e.next,c=e.actionName;return Promise.resolve(Promise.race([(0,e.action)(e.params,{actions:(0,e.consumerActions)(r.Actions[o],{modelName:o}),state:r.State[o]}),R(t,C(o,c))])).then(function(t){return e.newState=t||null,Promise.resolve(i(n)).then(function(){})})}catch(t){return Promise.reject(t)}}},setNewState:d,stateUpdater:v,subscription:h,tryCatch:m,config:f},P=function(t,e){try{e.next=function(t){return t.length>0&&t[0](e,t.slice(1))};var n=function(){if(t.length>0)return Promise.resolve(t[0](e,t.slice(1))).then(function(){})}();return Promise.resolve(n&&n.then?n.then(function(){}):void 0)}catch(t){return Promise.reject(t)}},w=n({}),N=w.Consumer;if(!console.group){var O=[],E="-".repeat(80);console.group=function(t){O.push(t),console.log("%c \nBEGIN GROUP: %c",E,t),console.groupEnd=function(){console.log("END GROUP: %c\n%c",O.pop(),E)}}}var j=function(t,e){var n={};return Object.keys(t).forEach(function(r){n[r]=function(t,e){return function(n,r){try{return Promise.resolve(P(y,{Global:l,action:t,actionName:t.name,consumerActions:j,middlewareConfig:r,modelName:e.modelName,newState:null,params:n,type:"outer"})).then(function(){})}catch(t){return Promise.reject(t)}}}(t[r],e)}),n},A=function(e,n){if("function"==typeof n){var r=l.State[e];r=t(r,n),l.State=t(l.State,function(t){t[e]=r})}else l.State=t(l.State,function(t){t[e]=s({},t[e],n)});return l.State},R=function(t,e){return new Promise(function(n){return setTimeout(function(){console.log(t),n(e)},t)})},x=function(e,n){try{var r={__FROM_SERVER__:!0};return Promise.resolve(Promise.all(Object.keys(l.State).map(function(o){try{var i=function(){if(!e||!e.modelName||o===e.modelName||-1!==e.modelName.indexOf(o)){var i=function(e){n&&n.isServer?r[o]=e:l.State=t(l.State,function(t){t[o]=s({},t[o],e)})},c=l.AsyncState[o];return c?Promise.resolve(c(e)).then(i):i({})}}();return Promise.resolve(i&&i.then?i.then(function(){}):void 0)}catch(t){return Promise.reject(t)}}))).then(function(){return n&&n.isServer?r:l.State})}catch(t){return Promise.reject(t)}},C=function(t,e){var n=localStorage.getItem("__REACT_MODELX__"+t+"_"+e);return n?JSON.parse(n):null},T=function(t,e){if(t===e)return!0;if("object"!=typeof t||null===t||"object"!=typeof e||null===e)return!1;var n=Object.keys(t),r=Object.keys(e);if(n.length!==r.length)return!1;for(var o=0;o<n.length;o++)if(!Object.prototype.hasOwnProperty.call(e,n[o])||t[n[o]]!==e[n[o]])return!1;return!0};function G(e,n,r){if(void 0!==e.state){l.uid+=1;var o="__"+l.uid;l.State=t(l.State,function(t){t[o]=e.state}),e.middlewares&&(l.Middlewares[o]=e.middlewares),l.Actions[o]=e.actions,l.AsyncState[o]=e.asyncState,n&&(l.Context[o]=n);var i=F(o);return{__id:o,actions:i,getState:function(){return k(o)},subscribe:function(t,e){return M(o,t,e)},unsubscribe:function(t){return D(o,t)},useStore:function(t){return I(o,t)}}}if(e.actions){console.error("invalid model(s) schema: ",e);var c=function(t){return function(){return t}};return{__ERROR__:!0,actions:c({}),getActions:c({}),getInitialState:c({}),getState:c({}),subscribe:c(),unsubscribe:c(),useStore:c([{},{}])}}n&&!n.__FROM_SERVER__&&(l.State=t(l.State,function(t){Object.assign(t,n||{})})),r&&(l.Context.__global=r),Object.keys(e).forEach(function(r){var o=e[r];if(o.__ERROR__)return console.error(r+" model's schema is invalid"),l.State=t(l.State,function(t){t[r]={}}),void(l.Actions[r]={});!function(t){return void 0!==t.useStore}(o)?(n&&n.__FROM_SERVER__?l.State=t(l.State,function(t){t[r]=s({},o.state,n[r])}):l.State[r]||(l.State=t(l.State,function(t){t[r]=o.state})),o.middlewares&&(l.Middlewares[r]=o.middlewares),l.Actions[r]=o.actions,l.AsyncState[r]=o.asyncState):(l.State[r]&&n||(l.State=t(l.State,function(t){t[r]=t[o.__id]})),n&&n.__FROM_SERVER__&&(l.State=t(l.State,function(t){t[r]=s({},t[o.__id],n[r])})),l.Actions[r]=l.Actions[o.__id],l.AsyncState[r]=l.AsyncState[o.__id],l.Middlewares[r]=l.Middlewares[o.__id],l.Context[r]=l.Context[o.__id])});var a=Object.keys(e).reduce(function(t,e){var n;return s({},t,((n={})[e]=F(e),n))},{});return l.withDevTools="undefined"!=typeof window&&window.__REDUX_DEVTOOLS_EXTENSION__,l.withDevTools&&(l.devTools=window.__REDUX_DEVTOOLS_EXTENSION__,l.devTools.connect()),{actions:a,getActions:F,getInitialState:x,getState:k,subscribe:M,unsubscribe:D,useStore:I}}e();var D=function(t,e){M(t,e,void 0)},M=function(t,e,n){Array.isArray(e)?e.forEach(function(e){l.subscriptions[t+"_"+e]||(l.subscriptions[t+"_"+e]=[]),n?l.subscriptions[t+"_"+e].push(n):l.subscriptions[t+"_"+e]=[]}):(l.subscriptions[t+"_"+e]||(l.subscriptions[t+"_"+e]=[]),n?l.subscriptions[t+"_"+e].push(n):l.subscriptions[t+"_"+e]=[])},k=function(t){return l.State[t]},F=function(t,e){void 0===e&&(e={type:"outer"});var n={};return Object.keys(l.Actions[t]).forEach(function(r){return n[r]=function(n,o){try{var i=s({action:l.Actions[t][r],actionName:r,consumerActions:j,middlewareConfig:o,modelName:t,newState:null,params:n},e,{Global:l}),c=l.Middlewares[t]?Promise.resolve(P(l.Middlewares[t],i)).then(function(){}):Promise.resolve(P(y,i)).then(function(){});return Promise.resolve(c&&c.then?c.then(function(){}):void 0)}catch(t){return Promise.reject(t)}}}),n},I=function(t,e){var n=r({})[1],c=o("");i(function(){l.uid+=1;var r=""+l.uid;return c.current=r,l.Setter.functionSetter[t]||(l.Setter.functionSetter[t]={}),l.Setter.functionSetter[t][r]={setState:n,selector:e},function(){delete l.Setter.functionSetter[t][r]}},[]);var a=F(t,{__hash:c.current,type:"function"});return[e?e(k(t)):k(t),a]},V=function(t){function e(){var e;return(e=t.apply(this,arguments)||this).state=l.State,e}return u(e,t),e.prototype.render=function(){var t=this.props.children;return l.Setter.classSetter=this.setState.bind(this),c(w.Provider,{value:s({},this.state)},t)},e}(a),L=function(t,e,n){return function(r){return function(o){function i(){return o.apply(this,arguments)||this}return u(i,o),i.prototype.render=function(){var o=this,i=this.props,a=i.state,u=void 0===a?{}:a,f=i.actions,m=void 0===f?{}:f;return c(N,null,function(i){var a=i[""+t],f=l.Actions[t];return c(r,Object.assign({},o.props,{state:s({},u,e?e(a):a),actions:s({},m,n?n(j(f,{modelName:t})):j(f,{modelName:t}))}))})},i}(a)}};export{N as Consumer,G as Model,V as Provider,y as actionMiddlewares,L as connect,x as getInitialState,k as getState,g as middlewares};
