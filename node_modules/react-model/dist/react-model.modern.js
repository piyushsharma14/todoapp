import t,{enableES5 as e}from"immer";import{createContext as o,useState as n,useRef as a,useEffect as s,PureComponent as c,createElement as i}from"react";var r={Actions:{},AsyncState:{},Context:{__global:{}},Middlewares:{},Setter:{classSetter:void 0,functionSetter:{}},State:{},devTools:void 0,subscriptions:{},uid:0,withDevTools:!1};const l={logger:{enable:!1},devtools:{enable:!1},tryCatch:{enable:!0}},S=async(t,e)=>{const{next:o}=t;l.tryCatch.enable?await o(e).catch(t=>console.log(t)):await o(e)},u=async(t,e)=>{const{action:o,modelName:n,consumerActions:a,params:s,next:c,Global:i}=t;t.newState=await o(s,{actions:a(i.Actions[n],{modelName:n}),state:i.State[n],...i.Context.__global||{},...i.Context[n]||{}})||null,await c(e)},d=async(t,e)=>{const{modelName:o,newState:n,next:a,Global:s}=t;s.Setter.functionSetter[o]&&Object.keys(s.Setter.functionSetter[o]).map(t=>{const e=s.Setter.functionSetter[o][t];e&&e.selector&&!e.selectorRef&&(e.selectorRef=e.selector(s.State[o]))}),n&&(O(o,n),await a(e))},m=async(t,e)=>{const{modelName:o,next:n,Global:a,__hash:s}=t,c=a.Setter.functionSetter[o];"function"===t.type&&s&&c&&c[s]&&c[s].setState&&c[s].setState(a.State[o]),await n(e)},_=async(t,e)=>{const{modelName:o,actionName:n,next:a,Global:s}=t,c=s.subscriptions[`${o}_${n}`];c&&c.forEach(t=>{t()}),await a(e)},b=async(t,e)=>{const{Global:o}=t;!0===l.logger.enable||"function"==typeof l.logger.enable&&l.logger.enable(t)?(console.group(`%c ${t.modelName} State Change %c ${(new Date).toLocaleTimeString()}`,"color: gray; font-weight: lighter;","color: black; font-weight: bold;"),console.log("%c Previous","color: #9E9E9E; font-weight: bold",o.State[t.modelName]),console.log("%c Action","color: #03A9F4; font-weight: bold",t.actionName,"payload: "+t.params),await t.next(e),console.log("%c Next","color: #4CAF50; font-weight: bold",o.State[t.modelName]),console.groupEnd()):await t.next(e)},f=async(t,e)=>{const{Global:o}=t;await t.next(e),o.withDevTools&&l.devtools.enable&&o.devTools.send(`${t.modelName}_${t.actionName}`,o.State)},w=async(t,e)=>{const{modelName:o,next:n,Global:a}=t;a.Setter.classSetter&&a.Setter.classSetter(a.State),a.Setter.functionSetter[o]&&Object.keys(a.Setter.functionSetter[o]).map(t=>{const e=a.Setter.functionSetter[o][t];if(e)if(e.selector){const t=e.selector(a.State[o]);$(t,e.selectorRef)||(e.selectorRef=t,e.setState(a.State[o]))}else e.setState(a.State[o])}),await n(e)},g=[S,b,f,u,d,m,w,_],p={communicator:w,consoleDebugger:b,devToolsListener:f,getNewState:u,getNewStateWithCache:(t=5e3)=>async(e,o)=>{const{action:n,Global:a,modelName:s,consumerActions:c,params:i,next:r,actionName:l}=e;e.newState=await Promise.race([n(i,{actions:c(a.Actions[s],{modelName:s}),state:a.State[s]}),A(t,v(s,l))])||null,await r(o)},setNewState:d,stateUpdater:m,subscription:_,tryCatch:S,config:l},y=async(t,e)=>{e.next=t=>t.length>0&&t[0](e,t.slice(1)),t.length>0&&await t[0](e,t.slice(1))},h=o({}),N=h.Consumer;if(!console.group){const t=[],e="-".repeat(80);console.group=function(o){t.push(o),console.log("%c \nBEGIN GROUP: %c",e,o),console.groupEnd=function(){console.log("END GROUP: %c\n%c",t.pop(),e)}}}const E=(t,e)=>{const o={};return Object.keys(t).forEach(n=>{o[n]=((t,e)=>async(o,n)=>{const a={Global:r,action:t,actionName:t.name,consumerActions:E,middlewareConfig:n,modelName:e.modelName,newState:null,params:o,type:"outer"};await y(g,a)})(t[n],e)}),o},O=(e,o)=>{if("function"==typeof o){let n=r.State[e];n=t(n,o),r.State=t(r.State,t=>{t[e]=n})}else r.State=t(r.State,t=>{t[e]={...t[e],...o}});return r.State},A=(t,e)=>new Promise(o=>setTimeout(()=>{console.log(t),o(e)},t)),R=async(e,o)=>{const n={__FROM_SERVER__:!0};return await Promise.all(Object.keys(r.State).map(async a=>{if(!e||!e.modelName||a===e.modelName||-1!==e.modelName.indexOf(a)){const s=r.AsyncState[a],c=s?await s(e):{};o&&o.isServer?n[a]=c:r.State=t(r.State,t=>{t[a]={...t[a],...c}})}})),o&&o.isServer?n:r.State},v=(t,e)=>{const o=localStorage.getItem(`__REACT_MODELX__${t}_${e}`);return o?JSON.parse(o):null},$=(t,e)=>{if(t===e)return!0;if("object"!=typeof t||null===t||"object"!=typeof e||null===e)return!1;const o=Object.keys(t),n=Object.keys(e);if(o.length!==n.length)return!1;for(let n=0;n<o.length;n++)if(!Object.prototype.hasOwnProperty.call(e,o[n])||t[o[n]]!==e[o[n]])return!1;return!0};function x(e,o,n){if(void 0!==e.state){r.uid+=1;const n="__"+r.uid;r.State=t(r.State,t=>{t[n]=e.state}),e.middlewares&&(r.Middlewares[n]=e.middlewares),r.Actions[n]=e.actions,r.AsyncState[n]=e.asyncState,o&&(r.Context[n]=o);const a=G(n);return{__id:n,actions:a,getState:()=>j(n),subscribe:(t,e)=>T(n,t,e),unsubscribe:t=>C(n,t),useStore:t=>D(n,t)}}{if(e.actions){console.error("invalid model(s) schema: ",e);const t=t=>(...e)=>t;return{__ERROR__:!0,actions:t({}),getActions:t({}),getInitialState:t({}),getState:t({}),subscribe:t(),unsubscribe:t(),useStore:t([{},{}])}}o&&!o.__FROM_SERVER__&&(r.State=t(r.State,t=>{Object.assign(t,o||{})})),n&&(r.Context.__global=n),Object.keys(e).forEach(n=>{const a=e[n];if(a.__ERROR__)return console.error(n+" model's schema is invalid"),r.State=t(r.State,t=>{t[n]={}}),void(r.Actions[n]={});(t=>void 0!==t.useStore)(a)?(r.State[n]&&o||(r.State=t(r.State,t=>{t[n]=t[a.__id]})),o&&o.__FROM_SERVER__&&(r.State=t(r.State,t=>{t[n]={...t[a.__id],...o[n]}})),r.Actions[n]=r.Actions[a.__id],r.AsyncState[n]=r.AsyncState[a.__id],r.Middlewares[n]=r.Middlewares[a.__id],r.Context[n]=r.Context[a.__id]):(o&&o.__FROM_SERVER__?r.State=t(r.State,t=>{t[n]={...a.state,...o[n]}}):r.State[n]||(r.State=t(r.State,t=>{t[n]=a.state})),a.middlewares&&(r.Middlewares[n]=a.middlewares),r.Actions[n]=a.actions,r.AsyncState[n]=a.asyncState)});const a=Object.keys(e).reduce((t,e)=>({...t,[e]:G(e)}),{});return r.withDevTools="undefined"!=typeof window&&window.__REDUX_DEVTOOLS_EXTENSION__,r.withDevTools&&(r.devTools=window.__REDUX_DEVTOOLS_EXTENSION__,r.devTools.connect()),{actions:a,getActions:G,getInitialState:R,getState:j,subscribe:T,unsubscribe:C,useStore:D}}}e();const C=(t,e)=>{T(t,e,void 0)},T=(t,e,o)=>{Array.isArray(e)?e.forEach(e=>{r.subscriptions[`${t}_${e}`]||(r.subscriptions[`${t}_${e}`]=[]),o?r.subscriptions[`${t}_${e}`].push(o):r.subscriptions[`${t}_${e}`]=[]}):(r.subscriptions[`${t}_${e}`]||(r.subscriptions[`${t}_${e}`]=[]),o?r.subscriptions[`${t}_${e}`].push(o):r.subscriptions[`${t}_${e}`]=[])},j=t=>r.State[t],G=(t,e={type:"outer"})=>{const o={};return Object.keys(r.Actions[t]).forEach(n=>o[n]=async(o,a)=>{const s={action:r.Actions[t][n],actionName:n,consumerActions:E,middlewareConfig:a,modelName:t,newState:null,params:o,...e,Global:r};r.Middlewares[t]?await y(r.Middlewares[t],s):await y(g,s)}),o},D=(t,e)=>{const o=n({})[1],c=a("");s(()=>{r.uid+=1;const n=""+r.uid;return c.current=n,r.Setter.functionSetter[t]||(r.Setter.functionSetter[t]={}),r.Setter.functionSetter[t][n]={setState:o,selector:e},function(){delete r.Setter.functionSetter[t][n]}},[]);const i=G(t,{__hash:c.current,type:"function"});return[e?e(j(t)):j(t),i]};class M extends c{constructor(){super(...arguments),this.state=r.State}render(){const{children:t}=this.props;return r.Setter.classSetter=this.setState.bind(this),i(h.Provider,{value:{...this.state}},t)}}const k=(t,e,o)=>n=>class extends c{render(){const{state:a={},actions:s={}}=this.props;return i(N,null,c=>{const{[""+t]:l}=c,S=r.Actions[t];return i(n,Object.assign({},this.props,{state:{...a,...e?e(l):l},actions:{...s,...o?o(E(S,{modelName:t})):E(S,{modelName:t})}}))})}};export{N as Consumer,x as Model,M as Provider,g as actionMiddlewares,k as connect,R as getInitialState,j as getState,p as middlewares};
