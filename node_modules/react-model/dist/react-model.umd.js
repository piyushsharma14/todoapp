!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("immer"),require("react")):"function"==typeof define&&define.amd?define(["exports","immer","react"],t):t((e=e||self).reactModel={},e.immer,e.react)}(this,function(e,t,n){var r="default"in t?t.default:t;function o(){return(o=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(e[r]=n[r])}return e}).apply(this,arguments)}function i(e,t){e.prototype=Object.create(t.prototype),e.prototype.constructor=e,e.__proto__=t}var c={Actions:{},AsyncState:{},Context:{__global:{}},Middlewares:{},Setter:{classSetter:void 0,functionSetter:{}},State:{},devTools:void 0,subscriptions:{},uid:0,withDevTools:!1},a={logger:{enable:!1},devtools:{enable:!1},tryCatch:{enable:!0}},s=function(e,t){try{var n=e.next,r=a.tryCatch.enable?Promise.resolve(n(t).catch(function(e){return console.log(e)})).then(function(){}):Promise.resolve(n(t)).then(function(){});return Promise.resolve(r&&r.then?r.then(function(){}):void 0)}catch(e){return Promise.reject(e)}},u=function(e,t){try{var n=e.modelName,r=e.next,i=e.Global;return Promise.resolve((0,e.action)(e.params,o({actions:(0,e.consumerActions)(i.Actions[n],{modelName:n}),state:i.State[n]},i.Context.__global||{},i.Context[n]||{}))).then(function(n){return e.newState=n||null,Promise.resolve(r(t)).then(function(){})})}catch(e){return Promise.reject(e)}},l=function(e,t){try{var n=e.modelName,r=e.newState,o=e.next,i=e.Global;i.Setter.functionSetter[n]&&Object.keys(i.Setter.functionSetter[n]).map(function(e){var t=i.Setter.functionSetter[n][e];t&&t.selector&&!t.selectorRef&&(t.selectorRef=t.selector(i.State[n]))});var c=function(){if(r)return E(n,r),Promise.resolve(o(t)).then(function(){})}();return Promise.resolve(c&&c.then?c.then(function(){}):void 0)}catch(e){return Promise.reject(e)}},f=function(e,t){try{var n=e.modelName,r=e.next,o=e.Global,i=e.__hash,c=o.Setter.functionSetter[n];return"function"===e.type&&i&&c&&c[i]&&c[i].setState&&c[i].setState(o.State[n]),Promise.resolve(r(t)).then(function(){})}catch(e){return Promise.reject(e)}},m=function(e,t){try{var n=e.next,r=e.Global.subscriptions[e.modelName+"_"+e.actionName];return r&&r.forEach(function(e){e()}),Promise.resolve(n(t)).then(function(){})}catch(e){return Promise.reject(e)}},d=function(e,t){try{var n=e.Global,r=!0===a.logger.enable||"function"==typeof a.logger.enable&&a.logger.enable(e)?(console.group("%c "+e.modelName+" State Change %c "+(new Date).toLocaleTimeString(),"color: gray; font-weight: lighter;","color: black; font-weight: bold;"),console.log("%c Previous","color: #9E9E9E; font-weight: bold",n.State[e.modelName]),console.log("%c Action","color: #03A9F4; font-weight: bold",e.actionName,"payload: "+e.params),Promise.resolve(e.next(t)).then(function(){console.log("%c Next","color: #4CAF50; font-weight: bold",n.State[e.modelName]),console.groupEnd()})):Promise.resolve(e.next(t)).then(function(){});return Promise.resolve(r&&r.then?r.then(function(){}):void 0)}catch(e){return Promise.reject(e)}},S=function(e,t){try{var n=e.Global;return Promise.resolve(e.next(t)).then(function(){n.withDevTools&&a.devtools.enable&&n.devTools.send(e.modelName+"_"+e.actionName,n.State)})}catch(e){return Promise.reject(e)}},v=function(e,t){try{var n=e.modelName,r=e.next,o=e.Global;return o.Setter.classSetter&&o.Setter.classSetter(o.State),o.Setter.functionSetter[n]&&Object.keys(o.Setter.functionSetter[n]).map(function(e){var t=o.Setter.functionSetter[n][e];if(t)if(t.selector){var r=t.selector(o.State[n]);A(r,t.selectorRef)||(t.selectorRef=r,t.setState(o.State[n]))}else t.setState(o.State[n])}),Promise.resolve(r(t)).then(function(){})}catch(e){return Promise.reject(e)}},h=[s,d,S,u,l,f,v,m],_={communicator:v,consoleDebugger:d,devToolsListener:S,getNewState:u,getNewStateWithCache:function(e){return void 0===e&&(e=5e3),function(t,n){try{var r=t.Global,o=t.modelName,i=t.next,c=t.actionName;return Promise.resolve(Promise.race([(0,t.action)(t.params,{actions:(0,t.consumerActions)(r.Actions[o],{modelName:o}),state:r.State[o]}),N(e,j(o,c))])).then(function(e){return t.newState=e||null,Promise.resolve(i(n)).then(function(){})})}catch(e){return Promise.reject(e)}}},setNewState:l,stateUpdater:f,subscription:m,tryCatch:s,config:a},p=function(e,t){try{t.next=function(e){return e.length>0&&e[0](t,e.slice(1))};var n=function(){if(e.length>0)return Promise.resolve(e[0](t,e.slice(1))).then(function(){})}();return Promise.resolve(n&&n.then?n.then(function(){}):void 0)}catch(e){return Promise.reject(e)}},b=n.createContext({}),y=b.Consumer;if(!console.group){var g=[],P="-".repeat(80);console.group=function(e){g.push(e),console.log("%c \nBEGIN GROUP: %c",P,e),console.groupEnd=function(){console.log("END GROUP: %c\n%c",g.pop(),P)}}}var w=function(e,t){var n={};return Object.keys(e).forEach(function(r){n[r]=function(e,t){return function(n,r){try{return Promise.resolve(p(h,{Global:c,action:e,actionName:e.name,consumerActions:w,middlewareConfig:r,modelName:t.modelName,newState:null,params:n,type:"outer"})).then(function(){})}catch(e){return Promise.reject(e)}}}(e[r],t)}),n},E=function(e,t){if("function"==typeof t){var n=c.State[e];n=r(n,t),c.State=r(c.State,function(t){t[e]=n})}else c.State=r(c.State,function(n){n[e]=o({},n[e],t)});return c.State},N=function(e,t){return new Promise(function(n){return setTimeout(function(){console.log(e),n(t)},e)})},O=function(e,t){try{var n={__FROM_SERVER__:!0};return Promise.resolve(Promise.all(Object.keys(c.State).map(function(i){try{var a=function(){if(!e||!e.modelName||i===e.modelName||-1!==e.modelName.indexOf(i)){var a=function(e){t&&t.isServer?n[i]=e:c.State=r(c.State,function(t){t[i]=o({},t[i],e)})},s=c.AsyncState[i];return s?Promise.resolve(s(e)).then(a):a({})}}();return Promise.resolve(a&&a.then?a.then(function(){}):void 0)}catch(e){return Promise.reject(e)}}))).then(function(){return t&&t.isServer?n:c.State})}catch(e){return Promise.reject(e)}},j=function(e,t){var n=localStorage.getItem("__REACT_MODELX__"+e+"_"+t);return n?JSON.parse(n):null},A=function(e,t){if(e===t)return!0;if("object"!=typeof e||null===e||"object"!=typeof t||null===t)return!1;var n=Object.keys(e),r=Object.keys(t);if(n.length!==r.length)return!1;for(var o=0;o<n.length;o++)if(!Object.prototype.hasOwnProperty.call(t,n[o])||e[n[o]]!==t[n[o]])return!1;return!0};t.enableES5();var R=function(e,t){x(e,t,void 0)},x=function(e,t,n){Array.isArray(t)?t.forEach(function(t){c.subscriptions[e+"_"+t]||(c.subscriptions[e+"_"+t]=[]),n?c.subscriptions[e+"_"+t].push(n):c.subscriptions[e+"_"+t]=[]}):(c.subscriptions[e+"_"+t]||(c.subscriptions[e+"_"+t]=[]),n?c.subscriptions[e+"_"+t].push(n):c.subscriptions[e+"_"+t]=[])},C=function(e){return c.State[e]},T=function(e,t){void 0===t&&(t={type:"outer"});var n={};return Object.keys(c.Actions[e]).forEach(function(r){return n[r]=function(n,i){try{var a=o({action:c.Actions[e][r],actionName:r,consumerActions:w,middlewareConfig:i,modelName:e,newState:null,params:n},t,{Global:c}),s=c.Middlewares[e]?Promise.resolve(p(c.Middlewares[e],a)).then(function(){}):Promise.resolve(p(h,a)).then(function(){});return Promise.resolve(s&&s.then?s.then(function(){}):void 0)}catch(e){return Promise.reject(e)}}}),n},M=function(e,t){var r=n.useState({})[1],o=n.useRef("");n.useEffect(function(){c.uid+=1;var n=""+c.uid;return o.current=n,c.Setter.functionSetter[e]||(c.Setter.functionSetter[e]={}),c.Setter.functionSetter[e][n]={setState:r,selector:t},function(){delete c.Setter.functionSetter[e][n]}},[]);var i=T(e,{__hash:o.current,type:"function"});return[t?t(C(e)):C(e),i]},G=function(e){function t(){var t;return(t=e.apply(this,arguments)||this).state=c.State,t}return i(t,e),t.prototype.render=function(){var e=this.props.children;return c.Setter.classSetter=this.setState.bind(this),n.createElement(b.Provider,{value:o({},this.state)},e)},t}(n.PureComponent);e.Consumer=y,e.Model=function(e,t,n){if(void 0!==e.state){c.uid+=1;var i="__"+c.uid;c.State=r(c.State,function(t){t[i]=e.state}),e.middlewares&&(c.Middlewares[i]=e.middlewares),c.Actions[i]=e.actions,c.AsyncState[i]=e.asyncState,t&&(c.Context[i]=t);var a=T(i);return{__id:i,actions:a,getState:function(){return C(i)},subscribe:function(e,t){return x(i,e,t)},unsubscribe:function(e){return R(i,e)},useStore:function(e){return M(i,e)}}}if(e.actions){console.error("invalid model(s) schema: ",e);var s=function(e){return function(){return e}};return{__ERROR__:!0,actions:s({}),getActions:s({}),getInitialState:s({}),getState:s({}),subscribe:s(),unsubscribe:s(),useStore:s([{},{}])}}t&&!t.__FROM_SERVER__&&(c.State=r(c.State,function(e){Object.assign(e,t||{})})),n&&(c.Context.__global=n),Object.keys(e).forEach(function(n){var i=e[n];if(i.__ERROR__)return console.error(n+" model's schema is invalid"),c.State=r(c.State,function(e){e[n]={}}),void(c.Actions[n]={});void 0===i.useStore?(t&&t.__FROM_SERVER__?c.State=r(c.State,function(e){e[n]=o({},i.state,t[n])}):c.State[n]||(c.State=r(c.State,function(e){e[n]=i.state})),i.middlewares&&(c.Middlewares[n]=i.middlewares),c.Actions[n]=i.actions,c.AsyncState[n]=i.asyncState):(c.State[n]&&t||(c.State=r(c.State,function(e){e[n]=e[i.__id]})),t&&t.__FROM_SERVER__&&(c.State=r(c.State,function(e){e[n]=o({},e[i.__id],t[n])})),c.Actions[n]=c.Actions[i.__id],c.AsyncState[n]=c.AsyncState[i.__id],c.Middlewares[n]=c.Middlewares[i.__id],c.Context[n]=c.Context[i.__id])});var u=Object.keys(e).reduce(function(e,t){var n;return o({},e,((n={})[t]=T(t),n))},{});return c.withDevTools="undefined"!=typeof window&&window.__REDUX_DEVTOOLS_EXTENSION__,c.withDevTools&&(c.devTools=window.__REDUX_DEVTOOLS_EXTENSION__,c.devTools.connect()),{actions:u,getActions:T,getInitialState:O,getState:C,subscribe:x,unsubscribe:R,useStore:M}},e.Provider=G,e.actionMiddlewares=h,e.connect=function(e,t,r){return function(a){return function(s){function u(){return s.apply(this,arguments)||this}return i(u,s),u.prototype.render=function(){var i=this,s=this.props,u=s.state,l=void 0===u?{}:u,f=s.actions,m=void 0===f?{}:f;return n.createElement(y,null,function(s){var u=s[""+e],f=c.Actions[e];return n.createElement(a,Object.assign({},i.props,{state:o({},l,t?t(u):u),actions:o({},m,r?r(w(f,{modelName:e})):w(f,{modelName:e}))}))})},u}(n.PureComponent)}},e.getInitialState=O,e.getState=C,e.middlewares=_});
